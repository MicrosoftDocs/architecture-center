This example workload shows an Azure Virtual WAN deployment with multiple hubs per region. To improve availability and scalability, each hub peers to geographically dispersed, redundant ExpressRoute circuits. This architecture is for exceptionally large and critical workloads. It supports business units and applications that reside on spoke virtual networks. The spoke virtual networks often have security requirements for internet-to-spoke or spoke-to-spoke connectivity.

## Architecture

￼

*Download a [Visio file]() of this architecture.*

### Workflow

The following workflow corresponds to the previous diagram:

1. Traffic from the spoke virtual networks to the internet routes through the NVA firewalls in the security virtual networks that are attached to the same hub as the spoke. The NVAs that are connected to the same hub as the spoke source or destination inspect all traffic between the spoke virtual networks and on-premises. This routing optimizes performance and retains secure traffic between on-premises and Azure.

1. Traffic between spokes that reside on different hubs should follow the path spoke > hub > hub > spoke. If spoke owners want more inspection, they must implement it within their spokes. This traffic shouldn't ride the Azure ExpressRoute, and security virtual network NVAs shouldn't inspect it.

1. Spoke-to-spoke traffic on the same hub should follow the path spoke > hub > spoke. Security virtual network NVAs shouldn't inspect this traffic.

### Components

- [Azure ExpressRoute](https://azure.microsoft.com/products/expressroute/) The architecture demonstrates the use of an Azure ExpressRoute circuit, which provides a private connection between your on-premises environment and Azure resources.
- [Azure Virtual WAN Standard](/azure/virtual-wan/virtual-wan-about) This architecture uses Azure Virtual WAN for transit networking and routing. It provides connection between your on-premises, via ExpressRoute, and your Azure resources.
  - **Custom route tables** Custom route tables optimize routing in the solution, so network-to-network traffic can bypass the firewalls. Network-to-on-premises traffic remains inspected.
  - **Labels** Labels in this solution eliminate the need to extensively propagate route individual networks to all the route tables, which simplifies the routing.
- [NVAs](https://azure.microsoft.com/solutions/network-appliances/) This architecture uses NVAs. Large organizations with established investment in firewall technology and management often require NVAs.
- [ExpressRoute Direct](/azure/expressroute/expressroute-erdirect-about) (optional) With this architecture, you can split off ExpressRoute circuits into local and standard circuits. The customer optimizes cost if the bandwidth necessary is already sufficient to justify using ExpressRoute Direct.

### Alternatives

An alternative is a hub and spoke virtual network model with Azure route servers. This alternative can enable greater performance than the 50Gbps limit per hub. This solution can have greater performance limits but more complexity.

For more information, see [Hub-spoke network topology in Azure](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke).

## Scenario details

1. This deployment maximizes the scalability of Virtual WAN leveraging multiple Virtual WAN hubs per region. As of the writing of this article, the number of virtual network connections to a single hub is \<500-Total number of Virtual WAN hubs in the services\> So for the design above with four hubs, each hub can support 496 virtual network connections. Additionally, since performance linearly scales with number of hubs the Virtual WAN design above provides both exceptional performance and virtual network space scaling.
1. This deployment uses an open bowtie design for ExpressRoute connectivity to the Virtual WAN hub. Each hub has two geographically dispersed ExpressRoute circuits. This solves many problems and enables the use of NVAs in the design.
   1. **Optimized interregional spoke-to-spoke routing** ExpressRoute is a preferred path for Virtual WAN because traffic can travel between two spokes attached to different hubs, for instance "Spoke VNet1" to "Spoke VNet5". If the design is a complete bowtie with a single ExpressRoute circuit that connects to Region1 VWAN Hub1 and Region2 VWAN Hub1, then traffic between the spokes follows the path Spoke VNet1 to Region1 VWAN Hub1. It goes down the ExpressRoute circuit and then back up the ExpressRoute path to Region2 VWAN Hub1 and then to Spoke VNet5. This design eliminates that path and enables the spoke-to-hub-to-hub-to-spoke path.
   1. **Cost Benefit** The design uses different ExpressRoute circuits, so the customer can use the local ExpressRoute SKU for all their standard operating traffic. The DR path is seldom used and is a standard circuit SKU, which optimizes the bandwidth cost in the solution.
   1. **Enable NVA inspection local to the spokes** This design enables traffic to utilize the NVA in the security virtual network that's attached to the same hub as the virtual network where the source of the traffic resides. During an ExpressRoute failure, the backup path continues to use the local NVA. The backup path simplifies routing, optimizes performance by avoiding inspection in multiple regions, and minimizes the risk of asymmetric routes by limiting complexity.
1. This deployment uses the custom NVA design which allows routing flexibility by using customer-defined route tables in the Virtual WAN.
1. This deployment provides highly redundant ExpressRoute connectivity for each hub. Highly redundant NVAs are attached to each hub.

Route tables:

## Region1 Hub 1 route tables

### Default route table

| Destination | Next hop |
|-------------|----------|
| 10.0.0.0/16 | SecurityVnet1Connection/NVA Internal IP Address |
| associated | Branches |
| propagated | Branches |
| labels | default, Hub1Default |

### Spokes route table

| Destination | Next hop |
|-------------|----------|
| 172.16.0.0/16 | SecurityVnet1Connection/NVA Internal IP Address |
| 0.0.0.0/0 | SecurityVnet1Connection/NVA Internal IP Address |
| associated | Spoke VNet1, Spoke VNet2 |
| propagated ||
| labels | AllWorkloadSpokes |

### Security route table

| Destination | Next hop |
|-------------|----------|
| associated | Security Vnet1 |
| propagated ||
| labels | Hub1SecuritySpokes, AllSecuritySpokes |

## Region1 Hub 2 Route Tables

### Default route table (Hub2)

| Destination | Next hop |
|-------------|----------|
| 10.1.0.0/16 | SecurityVnet2Connection/NVA Internal IP Address |
| associated | Branches |
| propagated | Branches |
| labels | default, Hub2Default |

### Spokes route table

| Destination | Next hop |
|-------------|----------|
| 172.16.0.0/16 | SecurityVnet2Connection/NVA Internal IP Address |
| 0.0.0.0/0 | SecurityVnet2Connection/NVA Internal IP Address |
| associated | Spoke Vnet3, Spoke Vnet4 |
| propagated ||
| labels | AllWorkloadSpokes |

### Security route table

| Destination | Next Hop |
|-------------|----------|
| associated | Security Vnet2 |
| propagated |
| labels | Hub2SecuritySpokes, AllSecuritySpokes |

 | **DEFAULT ROUTE TABLE (Hub3)** |
 | **SPOKES ROUTE TABLE** |
 | **SECURITY ROUTE TABLE** |
| **Region2 Hub1 Route Tables** | Destination | Next Hop |
 | Destination | Next hop |
 | Destination | Next hop |
| 10.2.0.0/16 | SecurityVnet3Connection/NVA Internal IP Address |
 | 172.16.0.0/16 | SecurityVnet3Connection/NVA Internal IP Address |
 |
 |
 |
|
 |
 |
 | 0.0.0.0/0 | SecurityVnet3Connection/NVA Internal IP Address |
 |
 |
 |
| associated | Branches |
 | associated | Spoke Vnet5, Spoke Vnet6 |
 | associated | Security Vnet3 |
| propagated | Branches |
 | propagated |
 |
 | propagated |
 |
| labels | default, Hub3Default |
 | labels | AllWorkloadSpokes |
 | labels | Hub3SecuritySpokes, AllSecuritySpokes |
|
 |
 |
 |
 |
 |
 |
 |
 |
 |
|
 | **DEFAULT ROUTE TABLE (Hub4)** |
 | **SPOKES ROUTE TABLE** |
 | **SECURITY ROUTE TABLE** |
| **Region2 Hub2 Route Tables** | Destination | Next Hop |
 | Destination | Next Hop |
 | Destination | Next Hop |
| 10.3.0.0/16 | SecurityVnet4Connection/NVA Internal IP Address |
 | 172.16.0.0/16 | SecurityVnet4Connection/NVA Internal IP Address |
 |
 |
 |
|
 |
 |
 | 0.0.0.0/0 | SecurityVnet3Connection/NVA Internal IP Address |
 |
 |
 |
| associated | Branches |
 | associated | Spoke Vnet7, Spoke Vnet8 |
 | associated | Security Vnet4 |
| propagated | Branches |
 | propagated |
 |
 | propagated |
 |
| labels | default, Hub4Default |
 | labels | AllWorkloadSpokes |
 | labels | Hub4SecuritySpokes, AllSecuritySpokes |

Labels:

| **Label** | **Propagated Vnet connections** |
| ---------- | ------------------------------- |
| AllWorkloadSpokes | SpokeVnet1Connection, SpokeVnet2Connection, SpokeVnet3Connection, SpokeVnet4Connection, SpokeVnet5Connection, SpokeVnet6Connection, SpokeVnet7Connection, SpokeVnet8Connection, SecurityVnet1Connection, SecurityVnet2Connection, SecurityVnet3Connection, SecurityVnet4Connection |
| AllSecuritySpokes | SpokeVnet1Connection, SpokeVnet2Connection, SpokeVnet3Connection, SpokeVnet4Connection, SpokeVnet5Connection, SpokeVnet6Connection, SpokeVnet7Connection, SpokeVnet8Connection |
| Hub1Default | SecurityVnet1Connection |
| Hub2Default | SecurityVnet2Connection |
| Hub3Default | SecurityVnet3Connection |
| Hub4Default | SecurityVnet4Connection |
| Hub1SecuritySpokes | SpokeVnet1Connection, SpokeVnet2Connection, SecurityVnet1Connection |
| Hub2SecuritySpokes | SpokeVnet3Connection, SpokeVnet4Connection, SecurityVnet2Connection |
| Hub3SecuritySpokes | SpokeVnet5Connection, SpokeVnet6Connection, SecurityVnet3Connection |
| Hub4SecuritySpokes | SpokeVnet7Connection, SpokeVnet8Connection, SecurityVnet4Connection |

This network architecture integrates seamlessly with the Cloud Adoption Framework for Virtual WAN where the Virtual WAN service, the ExpressRoute Connections, and the firewalls (and security virtual networks in this case) all reside in the connectivity subscription and the workloads, NSGs, and spoke virtual networks reside in separate landing zone subscriptions owned by the workload or application owners.

[Virtual WAN network topology](/azure/cloud-adoption-framework/ready/azure-best-practices/virtual-wan-network-topology)

### Potential use cases

This design is applicable to any business of sufficient size and footprint in Azure.

- Possible replacement for existing MPLS or Virtual WAN third party deployment.
- Massive Scale Cloud to on-premises connectivity.
- Supporting various business units and applications with disparate requirements and ownership within one tenant.

## Recommendations

**ExpressRoute recommendations:**

- ExpressRoute Direct – Customers of this scale often have previously established connectivity points and require very high bandwidth for their circuits. If a customer is migrating from a large scale MPLS (Multiprotocol Label Switching) such as NetBond and required +40Gbps circuit connectivity it can be advantageous to take advantage of their network infrastructure and establish ExpressRoute Direct. This also supports MACsec encryption for high security workloads.
- ExpressRoute Local – for cost optimization it is recommended that ExpressRoute Local is used to peer the primary ExpressRoute circuit to the regional hub of choice. The backup ExpressRoute circuit should use ExpressRoute Standard.

**Spoke recommendations:**

- Internet Egress – Egress internet traffic should route through the local NVA firewall connected to the same hub as the source virtual network for that traffic.
- Internet Ingress Inspection- If customers wish to inspect ingress internet connectivity for the spoke workloads, application gateway or frontdoor are viable options for WAF inspection of traffic into the spokes. SNAT will be required to avoid routing conflicts with the 0.0.0.0/0 route being advertised by the Virtual WAN Hub
- NSGs - Utilize NSGs to customize the security of the application residing in your spoke virtual network.

**NVA recommendations:**

- Redundancy – Follow a best practice architecture for NVA deployment redundancy including the use of multiple VM's or Scale Sets and load balancers to front end and backend the solution.

**Virtual WAN Hub Routing recommendations:**

- Spoke virtual network connections should only propagate to route table labels, and not to specific route tables. This simplifies infrastructure as code approaches.
- Each hub should have its own default hub label. This allows and limits propagation of the security virtual network routes to only that hub's default route table, instead of using the built-in "default" label, which would propagate across all hubs.
- Each hub should have a route table label for that hub's security virtual network. This streamlines infrastructure-as-code as virtual network connections will propagate to this label instead of a specific route table.

## Considerations

These considerations address the pillars of the Azure Well-Architected Framework, which is a set of guiding tenets that can be used to improve the quality of a workload. For more information, see [Microsoft Azure Well-Architected Framework](/azure/architecture/framework).

### Reliability

Reliability ensures your application can meet the commitments you make to your customers. For more information, see [Overview of the reliability pillar](/azure/architecture/framework/resiliency/overview).

This workload optimizes high availability with Virtual WAN, redundant ExpressRoute circuits, and scale sets for NVAs resulting in the redundancy necessary for highly critical workloads.

### Security

Security provides assurances against deliberate attacks and the abuse of your valuable data and systems. For more information, see [Overview of the security pillar](/azure/architecture/framework/security/overview).

This workload provides firewall inspection between Azure and on-premises as well as inspection for outgoing internet traffic from within Azure. For inbound internet traffic please consider Azure Front Door or Azure Application Gateway and utilize SNAT to avoid routing conflicts.

### Cost optimization

Cost optimization is about looking at ways to reduce unnecessary expenses and improve operational efficiencies. For more information, see [Overview of the cost optimization pillar](/azure/architecture/framework/cost/overview).

The pricing for many of the Azure components can be found in the Azure Pricing Calculator. Ultimately, pricing for this solution is based on factors such as:

- The Azure services that are used
- The ExpressRoute sizing
- The Virtual WAN sizing and data traffic quantities that are processed by each hub
- The NVA pricing

While this workload prioritizes performance and availability over low cost, cost is optimized by using ExpressRoute Local for primary connections limiting bandwidth expenses. If the customer would like to compromise on performance and reliability and optimize on cost they could reduce the number of ExpressRoute circuits, and the number of firewalls to drive down cost and ride the Virtual WAN Hubs with less efficiency to enable connection to their on-premises or cloud destinations.

### Operational excellence

Operational excellence covers the operations processes that deploy an application and keep it running in production. For more information, see [Overview of the operational excellence pillar](/azure/architecture/framework/devops/overview).

This design is compatible with Terraform/Infrastructure as code. Due to some Virtual WAN lag in feature availability it does require the use of the Terraform Azure API provider for deployment.

### Performance efficiency

Performance efficiency is the ability of your workload to scale to meet the demands placed on it by users in an efficient manner. For more information, see [Performance efficiency pillar overview](/azure/architecture/framework/scalability/overview).

This is a highly performant network even in the case of connection failure performance and routing uses the best available path.

## Deploy this scenario

The following steps establish the Virtual WAN service, hubs, spoke virtual networks, and ExpressRoutes. For a tutorial, see [Create an ExpressRoute association to Azure Virtual WAN](/azure/virtual-wan/virtual-wan-expressroute-portal).

1. Create a Virtual WAN service.
1. Deploy multiple hubs and an ExpressRoute gateway in each hub.
1. Deploy the required number of workload spoke virtual networks to support your workload and connect them to the desired hubs.
1. Establish connections between your ExpressRoute circuits and your hubs.
1. Deploy one security virtual network for each hub.
1. Deploy the NVA of your choosing and configure the firewall. Use NVA-specific documentation for this step. Establish the route tables and labels previously noted in the example [How to configure virtual hub routing: Azure portal - Azure Virtual WAN](/azure/virtual-wan/how-to-virtual-hub-routing).
1. Verify the routing.

## Contributors

*This article is maintained by Microsoft. It was originally written by the following contributors.*

Principal authors:

- [Ethan Haslett](https://www.linkedin.com/in/ethan-haslett-1502841/) | Sr Cloud Solution Architect
- [John Poetzinger](https://www.linkedin.com/in/john-poetzinger-467b9922/) | Sr Cloud Solution Architect

Other contributors:

- [Jimmy Avila](https://www.linkedin.com/in/jimmyavila/) | Sr Cloud Solution Architect
- [Andrew Delosky](https://www.linkedin.com/in/andrewdelosky/) | Principal Cloud Solution Architect
- [Robert Lightner](https://www.linkedin.com/in/robert-lightner/) | Sr Cloud Solution Architect

*To see non-public LinkedIn profiles, sign in to LinkedIn.*

## Next steps

- [About virtual hub routing](/azure/virtual-wan/about-virtual-hub-routing)
- [Route traffic through NVAs by using custom settings](/azure/virtual-wan/scenario-route-through-nvas-custom)
- [About ExpressRoute connections in Azure Virtual WAN](/azure/virtual-wan/virtual-wan-expressroute-about)

## Related resources

[Virtual WAN network topology](/azure/cloud-adoption-framework/ready/azure-best-practices/virtual-wan-network-topology?toc=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fazure%2Farchitecture%2Ftoc.json&bc=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fazure%2Farchitecture%2Fbread%2Ftoc.json)